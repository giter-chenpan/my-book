<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>逍遥君の小屋</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
        crossorigin="anonymous">
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/tiancai9Headers.css">

    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>
</head>
<style>
    .content {
        margin: 0 auto;
        margin-top: 2rem;
        width: 90%;
        min-width: 20rem;
    }
    .content-title {
        width: 100%;
        float: left;
    }
    .content-title-author, .content-comments-div-author {
        float: left;
        padding: .4rem;
        background-color: white;
        box-shadow: 1px 1px 1px #ccc;
    }
    .content-title-author-img, .content-comments-author-div-img {
        width: 3.2rem;
        border: 1px solid #ccc;
        padding: 0.05rem;
    }
    .content-title-author-name, .content-comments-div-author-name {
        color: #666666;
        margin: .2rem;
        font-weight: bold;
        font-size: 0.4rem;
        background-color: #f5f3f3;
        box-shadow: 3px 2px 1px #ccc;
    }
    .content-content, .content-comments-div-comments {
        float: left;
        margin-left: 5%;
        width: 75%;
    }
    .content-content-tilte {
        width: 100%;
        height: 1.8rem;
        border: 1px solid #ccc;
        background-color: white;
        box-shadow: 1px 1px 1px #ccc;
    }
    .content-content-tilte-name {
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        font-size: 0.4rem;
        font-weight: bold;
        padding: .2rem .3rem;
    }
    .content-content-tilte-time{
        padding: .2rem;
        width: 30%;
        float: left;
        color: #666666;
    }
    .content-content-tilte-right {
        width: 70%;
        padding: .2rem;
        float: left;
        color: #666666;
        text-align: right;
    }
    .content-content-tilte-right * {
        float: right;
        margin-right: .4rem;
    }
    .content-content-description {
        margin-top: .6rem;
        width: 100%;
        border: 1px solid #ccc;
        background-color: white;
        box-shadow: 1px 1px 1px #ccc;
    }
    .content-content-description-content {
        padding: .4rem;
        min-height: 5rem;
    }
    .content-content-tilte-right-status {
        cursor: pointer;
    }
    .content-comments {
        float: left;
        width: 100%;
        margin: .8rem 0;
    }
    .content-comments-div {
        float: left;
        width: 100%;
    }
    .content-comments-div-comments-content {
        border: 1px solid #ccc;
        box-shadow: 1px 1px 1px #ccc;
        background-color: white;
        padding: .4rem;
        min-height: .5rem;
        float: left;
        width: 100%;
    }
    .content-comments-div-comments-content-bottom {
        height: .4rem;
        font-size: .25rem;
    }
    .content-comments-div-comments-content-bottom * {
        float: right;
        margin: 0 .2rem;
        color: #666;
    }
    .content-comments-div-comments-content-comments {
        background-color: #f7f8fa;
        border: 1px solid #f0f1f2;
        float: left;
        width: 100%;
    }
    .content-comments-div-comments-content-comments-author {
        width: 100%;
    }
    .content-comments-div-comments-content-comments-author * {
        float: left;
    }
    .comments-author-img {
        width: 1.2rem;
        height: 1.2rem;
        padding: .1rem;
    }
    .comments-author-img img {
        width: 90%;
        height: 90%;
        border: 1px solid #ccc;
    }
    .comments-author-time {
        width: 100%;
        color: #666;
        font-size: .25rem;
    }
    .comments-author-description {
        width: 90%;
        line-height: .7rem;
        text-indent: .2rem;
    }
    .comments-author-time * {
        float: right;
        margin: 0 .2rem;
    }
    .content-comments-div-comments-content-input {
        float: left;
        width: 100%;
        position: relative;
    }
    .content-comments-div-comments-content-input * {
        float: left;
    }
    .content-input-button {
        padding: .1rem;
        background-color: white;
        border: 1px solid #ccc;
        width: 1.8rem;
        text-align: center;
        font-size: .25rem;
        margin-top: .3rem;
        margin-left: .2rem;
    }
    .content-input-textarea {
        resize: none;
        width: 80%;
        height: .8rem;
        margin-top: .2rem;
        border: 1px solid #ccc;
    }
    .content-input {
        float: left;
        width: 100%;
        background-color: white;
    }
    .btn-info {
        margin-top: .4rem;
        background-color: rgb(64, 158, 255);
        margin-bottom: 3rem;
    }

</style>

<body>
    <menu class="menu">
        <div class="menu-mylogo">
            <div class="menu-mylogo-logo">
                9
            </div>
            <div class="menu-mylogo-title">逍遥君の小屋</div>
        </div>
        <div class="menu-user">
            <ul>
                <li><a href="../index.html">首页</a></li>
                <li id="UserState"><a href="../views/login.html">登录</a></li>
                <li class="UserMymid"><a href="usermymid.html">个人中心</a></li>
                <li onclick="UserLogout()" class="UserMymid"><a>登出</a></li>
            </ul>
        </div>
    </menu>
    <!-- 内容 -->
    <div class="content">
        <!-- 文章 -->
        <div class="content-title">
            <div align="center" class="content-title-author">
                <img class="content-title-author-img" />
                <p class="content-title-author-name"></p>
            </div>
            <div class="content-content">
                <div class="content-content-tilte">
                    <div class="content-content-tilte-name"></div>
                    <div class="content-content-tilte-time"></div>
                    <div class="content-content-tilte-right">
                        <div class="content-content-tilte-right-see"></div>
                    </div>
                </div>
                <div class="content-content-description">
                    <div class="content-content-description-content">

                    </div>
                </div>
            </div>
        </div>
        <!-- 评论 -->
        <div class="content-comments">
            <div class="content-comments-div">
                <div align="center" class="content-comments-div-author">
                    <img src="http://127.0.0.1:3001/api/getimg?img=908f9200-efb4-11e8-9701-a7ae248e4b99.jpg" class="content-comments-author-div-img" />
                    <p class="content-comments-div-author-name">天啊</p>
                </div>
                <div class="content-comments-div-comments">
                    <div class="content-comments-div-comments-content">
                        <div class="content-comments-div-comments-content-txte" >啦啦啦啦</div>
                        <div class="content-comments-div-comments-content-bottom">
                            <div>收起回复</div>
                            <div>2018年11月24日16:28:45</div>
                            <div>1楼</div>
                        </div>
                        <div class="content-comments-div-comments-content-comments">
                            <div class="content-comments-div-comments-content-comments-author">
                                <div class="comments-author-img">
                                    <img src="http://127.0.0.1:3001/api/getimg?img=908f9200-efb4-11e8-9701-a7ae248e4b99.jpg" />
                                </div>
                                <div class="comments-author-description">
                                    啦啦啦
                                </div>
                                <div class="comments-author-time">
                                    <div>回复</div>
                                    <div>2018年11月24日17:35:44</div>
                                </div>
                            </div>
                            <div class="content-comments-div-comments-content-comments-author">
                                <div class="comments-author-img">
                                    <img src="http://127.0.0.1:3001/api/getimg?img=908f9200-efb4-11e8-9701-a7ae248e4b99.jpg" />
                                </div>
                                <div class="comments-author-description">
                                    天才9
                                </div>
                                <div class="comments-author-time">
                                    <div>回复</div>
                                    <div>2018年11月24日17:33:42</div>
                                </div>
                            </div>
                        </div>
                        <div class="content-comments-div-comments-content-input">
                            <textarea rows="2" class="content-input-textarea"></textarea>
                            <div class="content-input-button">我也说一句</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 评论输入框 -->
        <div class="content-input">
            <div id="editor"></div>
        </div>
        <button id="NewComnents" class="btn btn-info">评论</button>
    </div>
</body>
<script type="text/javascript" src="../js/result.js"></script>
<script type="text/javascript" src="../js/IfPC.js"></script>
<script type="text/javascript" src="../js/throttle.js"></script>
<script type="text/javascript" src="../js/tiancai9Headers.js"></script>
<script type="text/javascript" src="../js/canvasbackground.js"></script>
<script type="text/javascript" src="../js/ChinaDate.js"></script>
<!-- 富文本插件WangEditor -->
<script type="text/javascript" src="./NewTitle/wangEditor.min.js"></script>
<script type="text/javascript" >
    var descriptionString = ''
    var NowUrl = window.location.href
    var title_uid = NowUrl.substring(NowUrl.indexOf('title_uid=') + 10, NowUrl.length)

// 加载富文本
var E = window.wangEditor
var editor = new E('#editor')
editor.customConfig.zIndex = 1
editor.customConfig.menus = [
    'bold',
    'fontSize',
    'foreColor',
    'justify',
    'code',
    'image',
    'undo'
]
editor.create()

    $(document).ready(function() {
        // 根据向下滚动menu更改
        document.body.onscroll = throttle(Bodyonscroll, 30)
        // 动态背景
        CanvasBackground()
        // 获取文章
        if (NowUrl.indexOf('title_uid=') !== -1) {
            GetTitle(title_uid)
        } else {
            alert('页面不存在，点击确定跳回首页')
            window.open('../index.html')
        }
        // 获取评论
        GetComments(title_uid)
        // 新增评论
        $('#NewComnents').click(function() {
            if(token) {
                var description = JSON.stringify(editor.txt.getJSON())
                NewComments(title_uid, description)
            } else {
                alert('请登录后再回复')
            }
        })
    })

    function GetComments (title_uid, pageNum, pageSize) {
        $.get(url + 'api/findcomments', {
            title_uid: title_uid,
            pageNum: pageNum || 1,
            pageSize: pageSize || 10
        }, function(res) {
            console.log(res)
        })
    }

    function NewComments (title_uid, description) {
        var data = {
            title_uid: title_uid,
            comments_content: description
        }
        $.ajax({
            type: "post",
            url: url + 'api/newcomments',
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            jsonp: "callback",
            data: JSON.stringify(data),
            beforeSend: function(XMLHttpRequest) {
                XMLHttpRequest.setRequestHeader("tiancai9token", token);
            },
            success: function (res) {
                if(res.code == 200) {
                    console.log(res)
                }else {
                    alert(res.data)
                }
            },error:function(error){
                console.log(error);
            }
        });
    }

    function GetTitle (title_uid) {
        $.get(url + 'api/findtitle', {
            title_uid: title_uid
        }, function (res) {
            var data = res.data[0]
            $('.content-content-tilte-name').text(data.title_title)
            var title_time = format(data.title_time,'yyyy年MM月dd日 HH:mm:ss')
            $('.content-content-tilte-time').text(title_time)
            $('.content-content-tilte-right-see').text('阅读量：' + data.title_see)
            $('.content-title-author-name').text(data.user_name)
            // 根据用户name获取用户头像
            GetUserImg(data.user_name)
            var descriptionJson =  JSON.parse(data.title_description)
            // 获取文章内容
            GetDescription(descriptionJson)
            $('.content-content-description-content').html(descriptionString)
        })
    }

    function GetUserImg (path) {
        $.get(url + 'api/getuserimg', {
            user_name: path
        }, function (res) {
            if(res.code == 200) {
                $('.content-title-author-img').attr('src', url + 'api/getimg?img=' + res.data[0].user_img)
            }else {
                alert('获取用户头像失败，请刷新后重试')
            }
        })
    }

    function GetDescription (obj) {
        for(var i=0; i<obj.length;i++) {
            var tag = obj[i].tag
            if(tag) {
                if(obj[i].attrs.length !== 0) {
                    descriptionString += '<'+tag+' '+obj[i].attrs[0].name+'="'+obj[i].attrs[0].value+'" >'
                    GetDescription(obj[i].children)
                }else {
                    descriptionString += '<'+tag+'>'
                    GetDescription(obj[i].children)
                }
                descriptionString += '</'+tag+'>'
            }else {
                descriptionString += obj[0]
            }
        }
    }
</script>
</html>